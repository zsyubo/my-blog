# 什么是进程

进程就是运行起来的程序，程序运行起来需要被加载到内存中。当在内存中的程序运行执行起来时，就是一个进程了，进程是系统资源分配的基本单位。

linux支持两种进程：普通进程和实时进程。主要区别在实时进程有更短的响应时间。

# 进程组成

进程有3部分组成：进程控制块(PCB)、有关的程序段以及操作的数据集。

## PCB

主要包含进程的一些描述信息、资源信息以及控制信息等，系统为每个进程设置一个PCB。

当创建一个进程时，系统会首先创建其PCB，然后根据PCB中的信息对进程实施管理和控制，当程序执行完成后，系统则释放PCB，进程也随之消亡。

**PCB主要包含以下信息**

1. 进程标识。每个进程都有系统唯一的进程名称或标识号。在识别一个进程时，进程名或标识号就代表进程。
2. 状态信息。当前进程所处的状态，作为进程调度、分配处理机的依据。进程在活动期间有3种基本状态：就绪状态、执行状态和等待状态。一个进程在任一时刻只能具有3中状态的一种。
3. 进程优先级。优先级决定它何时运行和接收多少 CPU 时间。
4. CPU线程信息：当线程状态变化时，他需要将CPU线程保护到内存中，比如上下文切换，以便再次执行时恢复正常运行，`包括各种通用寄存器、程序计数器、程序状态字等。`
5. 资源清单：每个进程在运行时，除了需要内存外，还需要其他资源，如IO、数据区等。
6. 对列指针，用于将处于同一状态或者具有家族关系的进程连接成一个对列在该单元中存在下一进程PCB首地址。
7. 其他：如计时信息、记账信息、通讯信息等。

# task_struct 数据结构

Linux中每一个进程都由一个`task_struct`数据结构来表示，可以叫做进程控制块或者进程描述符。系统正式通过task_struct结构来对进程进行有效的管理和控制的。

当系统创建一个进程时，linux为新的进程分配一个task_struct结构，进程结束时，又收回task_struct结构，进程也随之消失。

在linux4.14内核中，Linux为每个新创建的进程动态分配一个task_struct结构，系统所能允许的最大进程数是由机器所拥有的的物理内存大小决定的。

### task_struct组成

1. 进程标识符信息

   进程标识符信息包括进程标识符、用户标识符、组标识符等一些信息。每个进程都有一个唯一的进程标识符(PID), 内核通过这个标识符来识别不同的进程。PID是32位无符号整数。

2. 进程调度信息：调度程序利用这些来决定哪个进程最迫切运行，并采用适当的策略来保证系统的公平性和高效性。

3. 进程间通信信息

4. 进程连接信息

5. 时间和定时器信息

6. 文件系统信息

7. 虚拟内存信息。

8. 处理器特定信息。

### PID 进程标识符

进程标识符也称为进程识别码(PID), 用来唯一表示某个进程。就算几个进程来自同一个程序，那么这些进程的PID也是不同的。进程运行时PID不会改变，进程终止后，PID会被系统回收，之后会被分配给其他新运行的进程。

在C中，PID是一个无符号整型数值(int)， 类型为 pid_t，4个字节。

**获取当前进程的ID**

```c++
#include <iostream>
#include <unistd.h>
using namespace std;
int main(int argc, const char * argv[]) {
    pid_t pid = getpid();
    cout << "pid=" << pid << endl;
    return 0;
}
```

程序每次运行的PID都不同。

### PID 文件

在linux系统中`/var/run`目录下，可以看到很多`*.pid`文件，这些PID文件为文本文件，内容只有一行,记录改进程的PID。

PID文件的作用是防止进程启动多个副本，只有获得相应PID文件写入权限的进程才能正常启动，并把自身的PID写入到该文件中。



# 进程的创建

linux可以通过执行系统调用函数fork来创建新线程 。有fork创建的新进程被称为子进程。该函数被调用一次返回2次。在子进程中返回值是0，而父进程的返回值是子进程的PID, 如果创建失败，父进程中返回-1，并且可以通过errno得到错误代码。

父子进程几乎是一样的，他们具有相同的变量，但是内存变量不同享，打开的文件也相同。`子进程相当于父进程的一个复制`，但他们并不共享内存。LInux采取的是写时复制(Copy on write)的基础，内存刚复制时由父子欧进程共享，而且内核将他们的许可权限改为只读，当有进程视图修改这些区域时，内核就为相关部分做一些复制。

**fork声明**

````c++
#include <unistd.h>
pid_t fork();
````









